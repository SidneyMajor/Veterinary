@model IEnumerable<Veterinary.Data.Entities.Appointment>

@{
    ViewData["Title"] = "Index";

}

@{

    List<object> commands = new List<object>();

    commands.Add(new { type = "Confirm", buttonOption = new { content = "", iconCss = "fas fa-clock text-warning", cssClass = "e-flat" } });

}
<div class="card badge-success">
    <div class="card-header badge-success">
        <h2 class="mb-0">
            <a class="text-lg-center text-white"><i class="fa fa-calendar-alt text-white"></i> Appointments</a>
        </h2>
    </div>


    <div class="card-body badge-light">
        <div class="accordion" id="accordionExample">
            <div class="card badge-info">
                <div class="card-header badge-info" id="headingOne">
                    <h2 class="mb-0">
                        <button class="btn btn-info btn-block text-left text-white" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            Appointment Schedule.
                        </button>
                    </h2>
                </div>

                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                    <div class="card-body badge-info">

                        <div class="schedule-wrapper">
                            <ejs-schedule id="schedule" height="650px" width="auto" selectedDate="DateTime.Today" endHour="18:00" startHour="08:00" cellClick="cellClick"
                                      eventRendered="onEventRendered"   eventClick="eventClick" currentView="WorkWeek" showQuickInfo="false" popupOpen="popupOpen">
                                <e-schedule-timescale interval="30" slotCount="1" ></e-schedule-timescale>
                                <e-schedule-eventsettings dataSource="Model" >

                                </e-schedule-eventsettings>
                            </ejs-schedule>

                        </div>
                    </div>
                </div>
            </div>

            @if (this.User.Identity.IsAuthenticated && (this.User.IsInRole("Admin") || this.User.IsInRole("Doctor")))
            {
                <div class="card badge-warning">
                    <div class="card-header" id="headingTwo">
                        <h2 class="mb-0">
                            <button class="btn btn-warning btn-block text-left collapsed text-white" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Schedule Pending
                            </button>
                        </h2>
                    </div>
                    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                        <div class="card-body">

                            <ejs-grid id="Grid" dataSource="@Model.Where(s=> s.Status=="Pending")" allowPaging="true" toolbar="@(new List<string>() {"Search" })" commandClick="commandClick">
                                <e-grid-pagesettings pageCount="5"></e-grid-pagesettings>
                                <e-grid-editSettings allowDeleting="false" allowEditing="false" mode="Normal"></e-grid-editSettings>
                                <e-grid-columns>
                                    <e-grid-column field="StartTime" headerText="Start Time" format="yyyy-MM-dd hh:mm" textAlign="Justify" width="100"></e-grid-column>
                                    <e-grid-column field="EndTime" headerText="End Time" width="100" format="yyyy-MM-dd hh:mm" textAlign="Justify"></e-grid-column>
                                    <e-grid-column field="Status" headerText="Status" width="50" textAlign="Justify"></e-grid-column>
                                    <e-grid-column field="Animal.Name" headerText="Animal" width="50" textAlign="Justify"></e-grid-column>
                                    <e-grid-column field="Specialty.Description" headerText="Specialty" width="50" textAlign="Justify"></e-grid-column>
                                    <e-grid-column field="Doctor.FullName" headerText="Doctor" width="50" textAlign="Justify"></e-grid-column>
                                    <e-grid-column headerText="Manage Records" width="100" commands="commands"></e-grid-column>

                                </e-grid-columns>
                            </ejs-grid>
                        </div>
                    </div>
                </div>
            }


        </div>

    </div>


</div>


<div id="PlaceHolder"></div>


@section Scripts {

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script type="text/javascript">

        function cellClick(event) {
        //The toISOString() method returns a string in simplified extended ISO format (ISO 8601),expected output: 2011-10-05T14:48:00.000Z
        //console.log(event.startTime.toISOString());
        //console.log(typeof event.startTime);
        //console.log(event.endTime.toISOString());
        //console.log(typeof event.endTime);

        $.ajax({
            type: 'GET',
            url: '@Url.Action("Create", "Appointments")',
            data: { startTime: event.startTime.toISOString(), endTime: event.endTime.toISOString() },
                success: function (res) {
                    var PlaceHolder = $("#PlaceHolder");
                    console.log(res);
                    PlaceHolder.html(res);
                    PlaceHolder.find('myModal').on('shown.bs.modal', function () {
                        $(document).off('focusin.modal')
                    });
                    PlaceHolder.find('.modal .modal-title').html('<i class="fas fa-comment-medical text-info"></i> Add Appointment');
                    PlaceHolder.find('.modal').modal('show');
                }
        })
    }

        function popupOpen(args) {
        args.cancel = true;
        @*$.ajax({
            type: 'GET',
            url: '@Url.Action("Edit", "Appointments")',
            data: { id: args.data.Id},
            success: function (res) {
                var PlaceHolder = $("#PlaceHolder");
                console.log(res);
                PlaceHolder.html(res);
                PlaceHolder.find('myModal').on('shown.bs.modal', function () {
                    $(document).off('focusin.modal')
                });
                PlaceHolder.find('.modal .modal-title').html('<i class="fas fa-comment-medical text-info"></i> Edit Appointment');
                PlaceHolder.find('.modal').modal('show');
            }
        })*@
    }

        function SpecialtyChange() {

        $("#DoctorID").empty();
        $.ajax({
           type: 'POST',
           url: '@Url.Action("GetDoctors","Appointments")',
           dataType: 'json',
           data: { specialtyId: $("#SpecialtyID").val() },
           success: function (doctors) {
              debugger;
              $("#DoctorID").append('<option value="0">(Select a Veterinary...)</option>');
              $.each(doctors, function (i, doctor) {
                 $("#DoctorID").append('<option value="'
                            + doctor.id + '">'
                            + doctor.fullName + '</option>');
              });
           },
           error: function (ex) {
                swal.fire('Failed to retrieve doctor.' + ex);
           }
        })
        return false;
    }

        function addAppointment() {

            $.ajax({
                type: 'POST',
                url: '@Url.Action("Create", "Appointments")',
                data: $("#form").serialize(),
                success: function (res) {
                    debugger;
                    if (res.isValid ==="success") {
                        $('#myModal').modal('hide');
                        var schObj = document.getElementById("schedule").ej2_instances[0];
                        schObj.eventSettings.dataSource = JSON.parse(res.appointments);
                        schObj.dataBind();
                    }
                    else if (res.isValid ==="failed")  {
                        $('#myModal').modal('hide');
                        swal.fire("Error", res.message, "warning");
                    }
                    else {
                        var PlaceHolder = $("#PlaceHolder");
                        //PlaceHolder.html(res);
                        var newBody = $('.modal-body', res);
                        PlaceHolder.find('.modal-body').replaceWith(newBody);
                        //PlaceHolder.find('.modal').modal('show');
                    }
                },
                error: function (ex) {
                    console.log(ex);
                    swal.fire(ex.statusText, 'Failed to create appointment.', "error");
                }


            })
        }

        function editAppointment() {

            $.ajax({
                type: 'POST',
                url: '@Url.Action("Edit", "Appointments")',
                data: $("#form").serialize(),
                dataType:"json",
                success: function (res) {
                    //debugger;
                    if (res.isValid ==="success") {
                        $('#myModal').modal('hide');
                        swal.fire("Success", res.message, "success");
                        var schObj = document.getElementById("schedule").ej2_instances[0];                       
                        schObj.eventSettings.dataSource = JSON.parse(res.appointments);
                        schObj.dataBind();
                    }
                    else if (res.isValid === "failed") {

                        swal.fire("Error", res.message, "warning");
                    }
                    else {
                        var PlaceHolder = $("#PlaceHolder");
                        //PlaceHolder.html(res);
                        var newBody = $('.modal-body', res);
                        PlaceHolder.find('.modal-body').replaceWith(newBody);
                        //PlaceHolder.find('.modal').modal('show');
                    }
                },
                error: function (ex) {
                    console.log(ex);
                    swal.fire(ex.statusText, 'Failed to create appointment.', "error");
                }
            })
        }

        function commandClick(args) {

        Swal.fire({
            title: 'Confirm schedule?',
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: 'Confirm',
            denyButtonText: 'Denied',
        }).then((result) => {
        /* Read more about isConfirmed, isDenied */
            var res = "";
            if (result.isConfirmed) {
                res = "Accepted";
            } else if (result.isDenied) {
                res = "Canceled";
            }

            $.ajax({
                type: 'POST',
                url: '@Url.Action("ConfirmSchedule", "Appointments")',
                data: { id: args.rowData.Id, status: res },
                success: function (res) {
                    if (res.result ==="Accepted") {
                        Swal.fire('Success!', 'Schedule Confirmed', 'success')
                    }
                    else {
                        Swal.fire('Denied', 'Schedule Denied', 'warning')
                    }
                   
                    var GridObj = document.getElementById("Grid").ej2_instances[0];
                    var schObj = document.getElementById("schedule").ej2_instances[0];
                    schObj.eventSettings.dataSource = JSON.parse(res.appointments);
                    schObj.dataBind();
                   
                    //GridObj.eventSettings.dataSource = res.appointments
                },
                error: function (ex) {
                    Swal.fire('Failed to confirm schedule.' + ex);
                }
            })

        })
    }


        function deleteAppointment() {

            Swal.fire({
                title: 'Are you sure you want to delete this?',
                showDenyButton: true,
                showCancelButton: true,
                showConfirmButton:false,
                //confirmButtonText: 'Confirm',
                denyButtonText: 'Confirm',
            }).then((result) => {
                debugger;
                var id = document.getElementById("modelId").value;
               
                if (result.isDenied) {

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("Delete", "Appointments")',
                        data: { id: id },
                        success: function (res) {
                            if (res.result === "success") {
                                Swal.fire('Success!', 'To Delete Schedule', 'success')
                                $('#myModal').modal('hide');
                                var schObj = document.getElementById("schedule").ej2_instances[0];
                                schObj.eventSettings.dataSource = JSON.parse(res.appointments);
                                schObj.dataBind();
                            }
                            else {
                                Swal.fire('Failed', 'Failed to delete schedule', 'warning')
                            }
                            //window.location.reload();
                        },
                        error: function (ex) {
                            Swal.fire('Failed to delete schedule.' + ex);
                        }
                    })
                }

            })
        }

        function eventClick(args) {

 
        debugger

         $.ajax({
            type: 'GET',
            url: '@Url.Action("Edit", "Appointments")',
             data: { id: args.event.Id},
            success: function (res) {
                var PlaceHolder = $("#PlaceHolder");
                console.log(res);
                PlaceHolder.html(res);
                PlaceHolder.find('myModal').on('shown.bs.modal', function () {
                    $(document).off('focusin.modal')
                });
                PlaceHolder.find('.modal .modal-title').html('<i class="fas fa-comment-medical text-info"></i> Edit Appointment');
                PlaceHolder.find('.modal').modal('show');
            }
        })
        }

        function onEventRendered(args) {           
           
            if (args.data.Status === "Accepted") {
                args.element.style["backgroundColor"]="green";
            }
            if (args.data.Status === "Pending") {
                args.element.style["backgroundColor"] = "orange";
            }
            if (args.data.Status === "Canceled") {
                args.element.style["backgroundColor"] = "red";
            }
        }

    </script>

}


